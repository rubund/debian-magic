export LIBS="/home/tim/gitsrc/magic-8.0"
script=$(mktemp)

cat > $script <<EOF || exit 1
#!/bin/bash

umask 0002

doerror() {
  echo "ERROR in \$LDIR: \$1" >&2
  exit 1
}

echohead() {
  git gc --auto --quiet
  echo "\$L:\$(git show-ref --hash refs/heads/master)"
}

commit() {
  git commit -n -a -m "Update at \$(date) by \$(id -nu)" > /dev/null || doerror "git commit"
}

for LDIR in \$LIBS ; do
  L=\$(basename \$LDIR)
  cd \$LDIR || doerror "cd LDIR"
  INIT=""

  if ! test -w . ; then
    echo "\$L:rsync"
  else

    if [ ! -d .git ] ; then
      if [ ! -f cdsinfo.tag ] ; then
        if [ -f config ] && [ -d objects ] ; then
          echohead
        else
          doerror "not a cadence library"
        fi
      else

        git init || doerror "git init"
        cat > .gitignore <<EO
*.*%
*.cdslck
.inca.db.*
inca.*.pak
*.swp
*~
*/av_extracted*/
.nfs*
*.cd-
*/mommdl/
EO
        git add .gitignore || doerror "git add .gitignore"
        git add . &> /dev/null
        commit
        git branch tomerge
        echohead
      fi
    else

      git add . &> /dev/null
      if ! git diff --quiet master ; then
        commit
      fi
      echohead
    fi
  fi
done

EOF

chmod +x $script
$script
rtn=$?
rm -f $script
exit $rtn
